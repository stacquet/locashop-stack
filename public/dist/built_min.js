angular.module("locashopApp",["uiGmapgoogle-maps","llNotifier","cgBusy","ngImgCrop","ui.router","angularFileUpload","appRoutes","ui.tinymce","ngResource"]),angular.module("appRoutes",[]).config(function(a,b){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"app/home/home.html"}).state("inscription",{url:"/inscription",templateUrl:"app/inscription/inscription.html",controller:"inscriptionController as vm"}).state("login",{url:"/login",templateUrl:"app/home/login.html"}).state("ferme",{url:"/ferme",templateUrl:"app/ferme/ferme.html",controller:"fermeController as vm"}).state("user",{url:"/user/:id_user",templateUrl:"app/user/user.html"}).state("user.infos",{url:"/infos",templateUrl:"app/user/userInfo.html",controller:"userInfoController as vmUserInfo"}).state("user.adresse",{url:"/adresse",templateUrl:"app/user/userMaps.html",controller:"userMapsController as vmUserMaps"}).state("user.mobile",{url:"/mobile",templateUrl:"app/user/userMobile.html",controller:"userMobileController as vmUserMobile"})}),function(){"use strict";function a(a,b,c,d){function e(){h.busy=d.login(h.user.email,h.user.password).success(function(c){a.userInfos=c.user,a.isLoggedIn=!0,b.path("/")}).error(function(a){console.log(a),h.messages=a.messages})}function f(){a.isLoggedIn||(h.busy=d.userInfos().success(function(b){a.userInfos=b,a.isLoggedIn=!0}))}function g(){h.busy=d.logout().success(function(){a.userInfos=null,a.isLoggedIn=!1,b.path("/")})}var h=this;h.login=e,h.logout=g,f()}angular.module("locashopApp").controller("homeController",a),a.$inject=["$rootScope","$location","notifier","homeService"]}(),function(){"use strict";function a(a){function b(){return a.get("/api/home/userInfos")}function c(){return a.get("/api/home/logout")}function d(b,c){return a.post("/api/home/login",{email:b,password:c})}var e={userInfos:b,logout:c,login:d};return e}angular.module("locashopApp").factory("homeService",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c){function d(){g.passwordEquals=g.user.password===g.user.passwordBis}function e(){g.busy=c.checkEmailAvailable(g.user.email).then(function(a){g.emailAvailable=a.data.checkEmailAvailable,g.userForm.email.$setValidity("notAvailable",g.emailAvailable)},function(){})}function f(){g.formSubmitted=!0,d(),g.passwordEquals&&g.userForm.$valid&&(g.busy=c.checkEmailAvailable(g.user.email).then(function(a){g.emailAvailable=a.data.checkEmailAvailable}).then(function(){g.userForm.$valid&&g.emailAvailable&&(g.loadingMessage="Inscription en base",g.busy=c.localSignup(g.user).then(function(){return g.loadingMessage="Envoi d'un email de vérification",c.emailVerification()}).then(function(){b.notify({template:"Nous vous avons envoyé un mail pour confirmer votre inscription"}),a.path("/")},function(){b.notify({template:"Nous n'avons pu vous envoyer un mail, veuillez contactez le support",type:"error"})}))}))}var g=this;g.passwordEquals=!0,g.emailAvailable=!0,g.loadingMessage="loading",g.formSubmitted=!1,g.checkPasswordEqual=d,g.checkEmailAvailable=e,g.localSignup=f}angular.module("locashopApp").controller("inscriptionController",a),a.$inject=["$location","notifier","inscriptionService"]}(),function(){"use strict";function a(a){function b(b){return a.post("/api/inscription/checkEmailAvailable",{email:b}).success(function(a){return console.log(a),a}).error(function(){})}function c(b){return a.post("/api/inscription/localSignup",b)}function d(){return a.get("/api/inscription/emailVerification")}var e={checkEmailAvailable:b,localSignup:c,emailVerification:d};return e}angular.module("locashopApp").factory("inscriptionService",a),a.$inject=["$http"]}(),function(){"use strict";function a(a){var b=a("/api/user/:id_user/adresse");return b}angular.module("locashopApp").factory("mapsService",a),a.$inject=["$resource"]}(),function(){"use strict";function a(a){var b=a("/api/user/:id_user/mobile");return b}angular.module("locashopApp").factory("mobileService",a),a.$inject=["$resource"]}(),function(){"use strict";function a(){function a(a,b,c){a.title=c.title,a.$watch(c.visible,function(a){$(b).modal(1==a?"show":"hide")}),$(b).on("shown.bs.modal",function(){a.$apply(function(a){a[c.visible]=!0})}),$(b).on("hidden.bs.modal",function(){a.$apply(function(a){a[c.visible]=!1})})}var b={template:'<div class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">{{ title }}</h4></div><div class="modal-body" ng-transclude></div></div></div></div>',restrict:"E",transclude:!0,replace:!0,scope:!1,link:a};return b}angular.module("locashopApp").directive("modal",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){b.showModal=!b.showModal}function j(){q.userProfil.adresse=h.getPosition(),console.log(q.userProfil.adresse),console.log(h.getPosition())}function k(){q.busy=m().then(function(){f.notify({template:"Sauvegarde OK"})},function(a){f.notify({template:a,type:"error"})})}function l(){q.busy=g.get({id:c.id_profil}).$promise.then(function(a){q.userProfil=a,a.Photo&&(q.profilImage=a.Photo.chemin_webapp+"/"+a.Photo.uuid+".jpg")})}function m(){var a=e.defer(),b=q.profilImageChanged?p(q.profilImage):!1,f={url:"/api/profil/"+c.id_profil,fields:{userProfil:q.userProfil},file:b};return d.upload(f).success(function(){a.resolve()}).error(function(b){console.log("pas bon"),a.reject("error : "+b)}),a.promise}function n(){if(q.files){console.log(q.files);var a=q.files[0],c=new FileReader;c.onload=function(a){b.$apply(function(){q.uploadedImage=a.target.result,b.showModal=!0})},c.readAsDataURL(a)}}function o(){q.profilImage=q.croppedImage,q.profilImageChanged=!0,i()}function p(a){for(var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=[],e=0;e<b.length;e++)d.push(b.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:c})}var q=this;q.uploadedImage="",q.croppedImage="",q.profilImage="",q.profilImageChanged=!1,q.saveProfil=k,q.checkAdresse=j,q.upload=m,q.crop=n,q.dataURItoBlob=p,q.toggleModal=i,q.updateProfilImage=o,q.userProfil={},b.showModal=!1,l(),q.options={language:"en",allowedContent:!0,entities:!1},b.$watch("vmProfil.files",function(){q.crop()}),b.$on("MAJ_ADRESSE",function(){console.log("Evénément reçu"),console.log(h.getPlace()),q.userProfil.adresse=h.getPlace(),b.myAdress=h.getPlace()})}angular.module("locashopApp").controller("profilController",a),a.$inject=["$timeout","$scope","$stateParams","$upload","$q","notifier","profilService","mapsService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){c.showModal=!c.showModal}function k(){a.busy=m().then(function(){e.go("user.adresse")},function(a){h.notify({template:a,type:"error"})})}function l(){a.busy=i.get({id:d.id_user}).$promise.then(function(a){q.user=a,a.Photo&&(q.profilImage=a.Photo.chemin_webapp+"/"+a.Photo.uuid+".jpg")})["finally"](function(){q.ajax=!0})}function m(){var a=g.defer(),b=q.profilImageChanged?p(q.profilImage):!1,c={url:"/api/user/"+d.id_user,fields:{user:q.user},file:b};return f.upload(c).success(function(){a.resolve()}).error(function(b){console.log("pas bon"),a.reject("error : "+b)}),a.promise}function n(){if(q.files){console.log(q.files);var a=q.files[0],b=new FileReader;b.onload=function(a){c.$apply(function(){q.uploadedImage=a.target.result,c.showModal=!0})},b.readAsDataURL(a)}}function o(){q.profilImage=q.croppedImage,q.profilImageChanged=!0,j(),console.log(q.user)}function p(a){for(var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=[],e=0;e<b.length;e++)d.push(b.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:c})}var q=this;q.uploadedImage="",q.croppedImage="",q.profilImage="",q.profilImageChanged=!1,q.saveProfil=k,q.upload=m,q.crop=n,q.dataURItoBlob=p,q.toggleModal=j,q.updateProfilImage=o,q.user={},q.ajax=!1,c.showModal=!1,l(),q.options={language:"en",allowedContent:!0,entities:!1},c.$watch("vmUserInfo.files",function(){q.crop()})}angular.module("locashopApp").controller("userInfoController",a),a.$inject=["$rootScope","$timeout","$scope","$stateParams","$state","$upload","$q","notifier","userService","mapsService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){m(),n.editMode="read",console.log(n.place.formatted_address),n.user.Adresse.formatted_address=n.place.formatted_address,n.user.Adresse.latitude=n.place.geometry.location.k,n.user.Adresse.longitude=n.place.geometry.location.B,a.busy=n.user.Adresse.$save({id_user:c.id_user}).then(function(){d.go("user.mobile"),n.place_changed=!1})}function k(){a.busy=i.get({id_user:c.id_user}).$promise.then(function(a){if(n.user.Adresse=a,n.user.Adresse){n.editMode="read";var c=new google.maps.LatLngBounds,d=new google.maps.LatLng(n.user.Adresse.latitude,n.user.Adresse.longitude);c.extend(d),b.map.bounds={northeast:{latitude:c.getNorthEast().lat(),longitude:c.getNorthEast().lng()},southwest:{latitude:c.getSouthWest().lat(),longitude:c.getSouthWest().lng()}};var e={id:0,latitude:n.user.Adresse.latitude,longitude:n.user.Adresse.longitude};b.map.markers.push(e),b.map.zoom=12}})["catch"](function(){n.user.Adresse=new i,n.editMode="new"})["finally"](function(){n.ajax=!0})}function l(){console.log(b.map)}function m(){b.showModal=!b.showModal}var n=this;b.showModal=!1,n.place_changed=!1,n.saveAdresse=j,n.logMap=l,n.editMode="edit",n.ajax=!1,n.user={id_user:c.id_user,Adresse:{}},f.doLog=!0,h.then(function(a){a.visualRefresh=!0,b.defaultBounds=new google.maps.LatLngBounds(new google.maps.LatLng(40.82148,-73.6645),new google.maps.LatLng(40.66541,-74.31715)),b.map.bounds={northeast:{latitude:b.defaultBounds.getNorthEast().lat(),longitude:b.defaultBounds.getNorthEast().lng()},southwest:{latitude:b.defaultBounds.getSouthWest().lat(),longitude:-b.defaultBounds.getSouthWest().lng()}},b.searchbox.options.bounds=new google.maps.LatLngBounds(b.defaultBounds.getNorthEast(),b.defaultBounds.getSouthWest())}),angular.extend(b,{selected:{options:{visible:!1},templateurl:"window.tpl.html",templateparameter:{}},map:{control:{},center:{latitude:47.472955,longitude:-.554351},zoom:10,dragging:!1,bounds:{},markers:[],idkey:"place_id",events:{idle:function(){},dragend:function(a){var c=a.getBounds(),d=c.getNorthEast(),e=c.getSouthWest();b.searchbox.options.bounds=new google.maps.LatLngBounds(e,d)}}},searchbox:{template:"searchbox.tpl.html",position:"top-left",options:{bounds:{}},parentdiv:"userMapsControllerParent",events:{places_changed:function(a){n.place_changed=!0;var c=a.getPlaces();if(0!=c.length){for(var d,e=[],f=new google.maps.LatLngBounds,g=0;d=c[g];g++){var h={id:g,place_id:d.place_id,name:d.name,latitude:d.geometry.location.lat(),longitude:d.geometry.location.lng(),options:{visible:!1},templateurl:"window.tpl.html",templateparameter:d,adresse:d};e.push(h),f.extend(d.geometry.location)}b.map.bounds={northeast:{latitude:f.getNorthEast().lat(),longitude:f.getNorthEast().lng()},southwest:{latitude:f.getSouthWest().lat(),longitude:f.getSouthWest().lng()}},_.each(e,function(a){a.onClicked=function(){n.place=a.adresse,b.showModal=!0}}),b.map.markers=e,b.map.zoom=12}}}}}),k()}angular.module("locashopApp").controller("userMapsController",a).config(["uiGmapGoogleMapApiProvider",function(a){a.configure({v:"3.16",libraries:"places"})}]).run(["$templateCache",function(a){a.put("searchbox.tpl.html",'<input id="pac-input" class="form-control" type="text" placeholder="Rechercher votre adresse">')}]),a.$inject=["$rootScope","$scope","$stateParams","$state","$timeout","uiGmapLogger","$http","uiGmapGoogleMapApi","mapsService","userService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){console.log("saving mobile"),a.busy=l.user.$save({id_user:d.id_user}).then(function(){})}function k(){a.busy=i.get({id_user:d.id_user}).$promise.then(function(a){l.user=a})["catch"](function(){l.user=new i,l.editMode="new"})["finally"](function(){l.ajax=!0})}var l=this;l.user={},l.ajax=!1,l.editMode="edit",l.saveMobile=j,k()}angular.module("locashopApp").controller("userMobileController",a),a.$inject=["$rootScope","$timeout","$scope","$stateParams","$state","$upload","$q","notifier","mobileService"]}(),function(){"use strict";function a(a){var b=a("/api/user/:id");return b}angular.module("locashopApp").factory("userService",a),a.$inject=["$resource"]}();